#!/bin/bash
DIRECTORY="${HOME}/printer_data/config/"
# klipper_path="~/printer_data/"
output_file=$DIRECTORY"klipper_device.cfg"
devices="/dev/serial/by-id/*"


PS3='Please enter your choice: '
options=("Clone Config" "Scan Device" "Option 3" "Quit")
select opt in "${options[@]}"
do
  case $opt in
		"Scan Device")
			echo "Scanning for connected Klipper device"
						### DEBUG
				        # cd "/"
                        # cd "/"  && touch $output_file
                        # cd "/" && echo $output_file
						### END DEBUG
			####	

			echo "# SIAUH Klipper Mainsail Device Configuration" > "$output_file"
			echo "# Auto-generated by script on $(date)" >> "$output_file"
			echo "" >> "$output_file"
			echo "[mcu]" >> "$output_file"
			echo "serial:" >> "$output_file"
			###
			### Debug
			# cd "/" && touch $output_file
			# cd "/" &&echo "rundle made" >> $output_file
			# cd "/" && echo "thisisme" >> $output_file
			### End Debug

			# for device in $devices; do
			# 	echo "[mcu]" >> "$output_file"
			# 	echo "serial: $device" >> "$output_file"
			# 	echo  "restart_method: command" >> "$output_file"
			# 	echo "" >> "$output_file"
			# done

		if [ -d "/dev/serial/by-id/" ];then
        path=$(ls /dev/serial/by-id/*)
        # echo $path
			if [ -f $output_file ];then
				echo $output_file
				# sed -i 's|original text|replacement text|g' $output_file
				sed -i "s|serial:.*|serial:'$path'|g" $output_file
				# sed -i 's|serial:.*|serial:${path}|g' $output_file
				# sed -i 's|serial:|serial:*|g' test.txt
			fi
		fi
			#done
				
			echo "Device configuration has been written to $output_file."
				;;
		"Clone Config")
			echo "Please select your printer:"
	    printer_options=("SV06" "SV06 Plus" "SV07" "SV07 Plus" "Quit")
	    select opt2 in "${printer_options[@]}"
	    do
	    	case $opt2 in
					"SV06")
						echo "Select Repo to clone from..."
						repo_options_06=("Sovol" "Bassamantor" "Go Back")
						select opt_06 in "${repo_options_06[@]}"
						do
							case $opt_06 in
								"Sovol")
									if [ -d "$DIRECTORY" ]; then
										echo "$DIRECTORY does exist."
							    			echo "Back up existing config folder..."
										mv ~/printer_data/config ~/printer_data/backup_config_siauh
									fi
									echo "Cloning Sovol Default config..."
									git clone https://github.com/dakhunter/SV06Sovol.git ~/printer_data/config
							    		;;
								"Bassamantor")
									if [ -d "$DIRECTORY" ]; then
										echo "$DIRECTORY does exist."
							    			echo "Back up existing config folder..."
										mv ~/printer_data/config ~/printer_data/backup_config_siauh
									fi
									echo "Cloning Sovol Default config..."
									git clone https://github.com/bassamanator/Sovol-SV06-firmware.git ~/printer_data/config
							    		;;
								"Go Back") 
									break 4
							;;
				    	esac
				done
				;;
					"SV06 Plus")
					echo "Select Repo to clone from..."
					repo_options_06P=("Sovol" "Bassamantor")
					select opt_06P in "${repo_options_06P[@]}"
					do
						case $opt_06P in
							"Sovol")
								echo "Cloning Sovol Default Config..."
								;;
							"Bassamantor")
								echo "Cloning from Bassamantor's repo..."
								;;
					   	esac
					done
					;;
				"SV07")
					echo "Select Repo to clone from..."
					repo_options_07=("Sovol" "Bassamantor")
					select opt_07 in "${repo_options_06P[@]}"
					do
						case $opt_07 in
							"Sovol")
								echo "To be developed"
								echo "Cloning Sovol Default Config..."
								;;
							"Bassamantor")
								echo "To be developed"
								echo "Cloning from Bassamantor's repo..."
								;;
					   	esac
					done
					;;
				"SV07 Plus")
					echo "Select Repo to clone from..."
					repo_options_07P=("Sovol" "Bassamantor")
					select opt_07P in "${repo_options_06P[@]}"
					do
						case $opt_07P in
							"Sovol")
								echo "To be developed"
								echo "Cloning Sovol Default Config..."
								;;
							"Bassamantor")
								echo "To be developed"
								echo "Cloning from Bassamantor's repo..."
								;;
					   	esac
					done
					;;
				"Quit")
					break
					;;
				
			esac
		    done
			
	            ;;
	        "Option 3")
	            echo "you chose choice $REPLY which is $opt"
	            ;;
	        "Quit")
	            break
	            ;;
	        *) echo "invalid option $REPLY";;
	    esac
	done
